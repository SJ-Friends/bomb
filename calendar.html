<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>BOMB SURF 예약 캘린더</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: #fff;
      margin: 0; padding: 0;
      color: #222;
    }
    .container {
      max-width: 900px;
      margin: 48px auto 0 auto;
      background: #fff;
      padding: 20px 10px 20px 10px;
    }
    .title-img { display: flex; justify-content: center; margin-bottom: 12px;}
    .title-img img { height: 44px; }
    .calendar-header-wrap {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 14px;
      gap: 8px;
      flex-wrap: wrap;
    }
    .calendar-nav {
      display: flex; align-items: center; gap: 10px;
    }
    .calendar-nav-btn {
      background: #0d6efd;
      color: #fff;
      font-size: 1.15em;
      border: none;
      border-radius: 7px;
      padding: 7px 18px;
      cursor: pointer;
      font-weight: 600;
      transition: background 0.13s, box-shadow 0.13s;
      box-shadow: 0 2px 8px rgba(13,110,253,0.08);
    }
    .calendar-nav-btn:hover { background: #0b5ed7;}
    .month-label {
      font-size: 1.11em;
      font-weight: 700;
      color: #232323;
      margin: 0 5px;
      min-width: 90px;
      text-align: center;
      letter-spacing: 0.01em;
    }
    .page-btns { display: flex; gap: 8px;}
    .add-btn {
      background: #26b66c;
      color: #fff;
      border: none;
      border-radius: 7px;
      padding: 8px 20px;
      font-size: 1em;
      font-weight:600;
      cursor: pointer;
      transition: background 0.11s;
      box-shadow: 0 2px 8px rgba(38,182,108,0.10);
    }
    .add-btn:hover { background: #189052;}
    .list-btn {
      background: #1d90ff;
      color: #fff;
      border: none;
      border-radius: 7px;
      padding: 8px 20px;
      font-size: 1em;
      font-weight:600;
      cursor: pointer;
      transition: background 0.11s;
      box-shadow: 0 2px 8px rgba(29,144,255,0.09);
    }
    .list-btn:hover { background: #146fcc;}
    .calendar-wrap { margin: 0 auto; }

    .calendar {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 4px;
      margin-top: 6px;
      border: 1px solid #e0e0e0;
      border-radius: 0;
      background: #fff;
      box-shadow: none;
    }
    .cal-header {
      text-align: center;
      font-weight: 600;
      background: #f7faff;
      color: #1a3d6d;
      padding: 8px 0 7px 0;
      border-radius: 0;
      font-size:1em;
      letter-spacing: 0.01em;
      border-bottom: 1px solid #e6e6e6;
    }
    .cal-cell {
      background: #fff;
      border-radius: 0;
      min-height: 65px;
      padding: 3px 2px 2px 2px;
      font-size: 1em;
      position: relative;
      cursor:pointer;
      border: 1px solid #ededed;
      border-top: none;
      border-left: none;
      display:flex;
      flex-direction:column;
      box-shadow: none;
      transition: background 0.12s, border 0.13s;
    }
    .cal-cell.today {
      border: 1.5px solid #ffe8a3 !important;
      background: #fffbe8 !important; /* 연노랑 */
    }
    .cal-date {
      font-size: 0.98em;
      font-weight: 600;
      color: #212325;
      margin-bottom: 1px;
      text-align: right;
      letter-spacing: 0.01em;
    }
    .res-list { margin: 0; padding: 0; list-style: none;}
    .res-item {
      background: #e9f7ef; /* 렌탈(기본: 연그린) */
      border-radius: 3px;
      margin: 3px 0 0 0;
      padding: 5px 9px 4px 9px;
      font-weight: 500;
      color: #111;
      font-size: 1em;
      display: block;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
      border: none;
      letter-spacing:0.01em;
      box-shadow: none;
      transition: background 0.13s;
      cursor: pointer;
    }
    .res-item.lesson {
      background: #ffe5b4 !important; /* 강습: 연주황 */
      color: #111;
    }
    .res-item:hover { background: #c1eed6;}
    .res-item.lesson:hover { background: #ffd488 !important;}
    .legend-bar {
      display: flex; align-items: center; gap: 16px;
      font-size: 0.98em;
      margin: 24px 0 8px 2px;
    }
    .legend-sample {
      display: inline-block;
      width: 36px; height: 20px;
      border-radius: 4px;
      margin-right: 6px;
      border: 1px solid #e3e3e3;
      vertical-align: middle;
    }
    .legend-lesson { background: #ffe5b4; border: 1px solid #ffe5b4;}
    .legend-rental { background: #e9f7ef; border: 1px solid #e9f7ef;}
    .modal-bg { display: none; position: fixed; left:0; top:0; width:100vw; height:100vh; background:rgba(18,20,24,0.12); z-index:99; align-items: center; justify-content: center;}
    .modal-box { background: #fff; border-radius: 10px; padding: 24px 18px 14px 18px; max-width: 340px; width:95vw; box-shadow: 0 10px 24px rgba(60,60,60,0.13);}
    .modal-title { font-weight: bold; font-size:1.09em; margin-bottom: 13px; color: #2b2b2b;}
    .modal-close { background: none; border: none; font-size: 1.3em; color: #999; position: absolute; top: 8px; right: 11px; cursor:pointer;}
    .modal-listitem {
      background: #e9f7ef;
      border-radius: 3px;
      padding: 7px 8px 5px 8px;
      margin: 6px 0;
      font-size:0.97em;
      font-weight:500; color:#257a51;
      border: none;
      display:flex; flex-direction:column; align-items:flex-start; white-space:normal;
      letter-spacing:0.01em;
      box-shadow: none;
    }
    .modal-listitem.lesson {
      background: #ffe5b4 !important;
      color: #a06700;
    }
    .modal-name { color: #189052; font-weight: bold; margin-right: 4px; }
    .modal-row { display: flex; align-items:center; gap:8px; margin-bottom:2px; flex-wrap: wrap;}
    .modal-memo { color: #555; font-size:0.96em; margin-left: 2px;}
    .modal-label { color:#888; font-size:0.97em;}
    .modal-listitem:last-child {margin-bottom:0;}
    .modal-name:hover { color: #146fcc; }
    @media (max-width: 1000px) {
      .container { max-width:99vw; }
    }
    @media (max-width: 740px) {
      .container { max-width:100vw; padding: 7px; }
      .calendar { grid-template-columns: repeat(7, 1fr);}
      .modal-box { max-width:97vw;}
      .calendar-header-wrap { flex-direction:column; gap:3px; }
    }
    @media (max-width:500px) {
      .calendar { gap:2px;}
      .cal-header { font-size:0.96em;}
      .cal-cell { min-height: 46px; padding:2px;}
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="title-img">
      <img src="title.jpg" alt="BOMB SURF">
    </div>
    <div class="calendar-header-wrap">
      <div class="calendar-nav">
        <button type="button" class="calendar-nav-btn" id="prevMonth">&#8592;</button>
        <span class="month-label" id="monthLabel"></span>
        <button type="button" class="calendar-nav-btn" id="nextMonth">&#8594;</button>
      </div>
      <div class="page-btns">
        <button class="list-btn" onclick="location.href='list.html'">전체 예약 목록</button>
        <button class="add-btn" onclick="location.href='input.html'">+ 예약 입력</button>
      </div>
    </div>
    <div class="calendar-wrap">
      <div class="calendar" id="calendarGrid"></div>
    </div>
    <div class="legend-bar">
      <span><span class="legend-sample legend-lesson"></span>강습</span>
      <span><span class="legend-sample legend-rental"></span>렌탈</span>
    </div>
  </div>
  <!-- 예약 상세 모달 -->
  <div class="modal-bg" id="modalBg">
    <div class="modal-box" style="position:relative;">
      <button class="modal-close" id="modalCloseBtn">&times;</button>
      <div class="modal-title" id="modalTitle"></div>
      <ul class="res-list" id="modalResList"></ul>
    </div>
  </div>
  <script>
    // Supabase 설정
    const supabase = window.supabase.createClient(
      'https://xxmtxuhcdzidhrefrvwf.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inh4bXR4dWhjZHppZGhyZWZydndmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDQwODAyNTQsImV4cCI6MjA1OTY1NjI1NH0.TaCCDlJvKrif_pZY038Qkglip8h-Qqjp2w2GlKwvoVg'
    );

    let today = new Date();
    let currYear = today.getFullYear();
    let currMonth = today.getMonth();

    function fmtDate(d) { return d.toISOString().slice(0,10);}
    function z(n) { return n<10?'0'+n:n; }
    const weekNames = ['일','월','화','수','목','금','토'];

    let reservations = [];

    // 달력 렌더
    async function renderCalendar() {
      document.getElementById('calendarGrid').innerHTML = '';
      // 해당월 예약 불러오기
      const firstDay = new Date(currYear, currMonth, 1);
      const lastDay = new Date(currYear, currMonth+1, 0);
      const fromDate = fmtDate(firstDay);
      const toDate = fmtDate(lastDay);

      const { data, error } = await supabase
        .from('reservations')
        .select('*')
        .gte('date', fromDate)
        .lte('date', toDate)
        .order('date', { ascending: true })
        .order('time', { ascending: true });

      reservations = data || [];

      // 달력 헤더
      weekNames.forEach(w => {
        const cell = document.createElement('div');
        cell.className = 'cal-header';
        cell.textContent = w;
        document.getElementById('calendarGrid').appendChild(cell);
      });

      // 첫 요일
      const startDay = firstDay.getDay();
      const daysInMonth = lastDay.getDate();
      for(let i=0; i<startDay; i++) {
        const cell = document.createElement('div');
        cell.className = 'cal-cell';
        cell.style.background = 'transparent';
        cell.style.cursor = 'default';
        document.getElementById('calendarGrid').appendChild(cell);
      }

      for(let d=1; d<=daysInMonth; d++) {
        const dateStr = currYear+'-'+z(currMonth+1)+'-'+z(d);
        const dayRes = reservations.filter(r=>r.date===dateStr);
        const cell = document.createElement('div');
        cell.className = 'cal-cell' + (dateStr === fmtDate(today) ? ' today' : '');
        cell.setAttribute('data-date', dateStr);

        // 날짜
        const dateDiv = document.createElement('div');
        dateDiv.className = 'cal-date';
        dateDiv.textContent = d;
        cell.appendChild(dateDiv);

        // 예약 목록
        if(dayRes.length > 0){
          const ul = document.createElement('ul');
          ul.className = 'res-list';
          dayRes.forEach(r=>{
            const li = document.createElement('li');
            li.className = r.lesson ? 'res-item lesson' : 'res-item';
            li.textContent =
              r.name +
              (r.people_count ? `(${r.people_count})` : '') +
              (r.time ? ` ${r.time}` : '');
            li.onclick = ()=>{ window.location.href = `update.html?id=${r.id}`; };
            ul.appendChild(li);
          });
          cell.appendChild(ul);
        }
        // 날짜 클릭 시 모달
        cell.onclick = ()=>{
          openModal(dateStr);
        };

        document.getElementById('calendarGrid').appendChild(cell);
      }
    }

    // 월 전후 이동
    document.getElementById('prevMonth').onclick = ()=>{
      if(currMonth===0) { currMonth=11; currYear--; }
      else currMonth--;
      updateMonthLabel();
      renderCalendar();
    };
    document.getElementById('nextMonth').onclick = ()=>{
      if(currMonth===11) { currMonth=0; currYear++; }
      else currMonth++;
      updateMonthLabel();
      renderCalendar();
    };
    function updateMonthLabel() {
      document.getElementById('monthLabel').textContent =
        currYear + '년 ' + z(currMonth+1) + '월';
    }

    // 모달 열기 (이름/인원/시간/메모)
    function openModal(dateStr) {
      const modalBg = document.getElementById('modalBg');
      const modalTitle = document.getElementById('modalTitle');
      const modalResList = document.getElementById('modalResList');
      const list = reservations.filter(r=>r.date===dateStr);
      modalTitle.textContent = `${dateStr} 예약 목록`;
      modalResList.innerHTML = '';
      if(list.length === 0){
        modalResList.innerHTML = '<li>예약 없음</li>';
      } else {
        list.forEach(r=>{
          const li = document.createElement('li');
          li.className = r.lesson ? 'modal-listitem lesson' : 'modal-listitem';
          li.textContent =
            r.name +
            (r.people_count ? `(${r.people_count})` : '') +
            (r.time ? ` ${r.time}` : '');
          modalResList.appendChild(li);
        });
      }
      modalBg.style.display = 'flex';
    }

    // 모달 닫기
    document.getElementById('modalCloseBtn').onclick = function(){
      document.getElementById('modalBg').style.display = 'none';
    }
    document.getElementById('modalBg').onclick = function(e){
      if(e.target === this) this.style.display='none';
    };

    function init(){
      updateMonthLabel();
      renderCalendar();
    }
    init();
  </script>
</body>
</html>
